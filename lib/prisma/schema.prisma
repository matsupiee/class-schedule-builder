// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client"
    output   = "../../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

model Subject {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    name String // "国語"

    requiredLessonCounts RequiredLessonCount[]
    fixedTimetableSlots  FixedTimetableSlot[]
    subjectUnits         SubjectUnit[]
    actualTimetableSlots ActualTimetableSlot[] @relation("SubjectActualTimetableSlots")
}

model Term {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    name String // "1学期" etc

    startsAt DateTime // 開始日時
    endsAt   DateTime // 終了日時

    requiredLessonCounts RequiredLessonCount[]
    calendarDays         CalendarDay[]
    fixedTimetableSlots  FixedTimetableSlot[]
    weeklyDayRules       WeeklyDayRule[]
    actualTimetableSlots ActualTimetableSlot[]
}

model WeeklyDayRule {
    id               String @id @default(cuid())
    termId           String
    weekday          Int // 1=Mon .. 5=Fri
    defaultSlotCount Int // 曜日ごとにコマ数がデフォルトで決まっている

    term Term @relation(fields: [termId], references: [id])

    @@unique([termId, weekday])
}

enum DayType {
    NORMAL
    WEEKLY_OFF
    HOLIDAY // 祝日
    SCHOOL_EVENT // 学校行事(運動会など)
}

model CalendarDay {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    termId  String
    date    DateTime
    title   String? // 行事名など
    dayType DayType

    // その日のコマ数
    slotCount Int

    term                 Term                  @relation(fields: [termId], references: [id])
    actualTimetableSlots ActualTimetableSlot[]

    @@unique([termId, date])
}

// 法定の必要授業数
model RequiredLessonCount {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    termId        String
    subjectId     String
    requiredCount Int

    term    Term    @relation(fields: [termId], references: [id])
    subject Subject @relation(fields: [subjectId], references: [id])

    @@unique([termId, subjectId])
}

// 固定時間割
model FixedTimetableSlot {
    id String @id @default(cuid())

    termId String

    weekday      Int // 1=Mon..7
    daySlotIndex Int // 1..N

    subjectId String

    name String? // "基本固定時間割"（グルーピング用）
    note String? // 備考

    term    Term    @relation(fields: [termId], references: [id])
    subject Subject @relation(fields: [subjectId], references: [id])

    @@unique([termId, weekday, daySlotIndex])
}

// 科目ごとの単元
model SubjectUnit {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    subjectId String
    unitName  String // "ごんきつね"など
    slotCount Int // その単元のコマ数（例：8）
    order     Int // その科目内での順番（1, 2, 3...）

    subject              Subject               @relation(fields: [subjectId], references: [id])
    actualTimetableSlots ActualTimetableSlot[]

    @@unique([subjectId, order])
}

// 実際の日付ベースの時間割スロット
model ActualTimetableSlot {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    termId        String
    calendarDayId String // 実際の日付
    daySlotIndex  Int // その日のコマ番号

    subjectId     String?
    subjectUnitId String? // どの単元か
    unitSlotIndex Int? // その単元内でのコマ番号（1, 2, 3...）

    // 授業として使えないコマの場合はここに値が入る（DaySlotのdisabledReasonを統合）
    disabledReason String?

    term        Term         @relation(fields: [termId], references: [id])
    calendarDay CalendarDay  @relation(fields: [calendarDayId], references: [id])
    subject     Subject?     @relation("SubjectActualTimetableSlots", fields: [subjectId], references: [id])
    subjectUnit SubjectUnit? @relation(fields: [subjectUnitId], references: [id])

    @@unique([termId, calendarDayId, daySlotIndex])
}
